<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
     <!--
    Greens
    -----------
    green #3CCF00
    drak green #006837

    blocks
    ---------
    d grey #333333
    mid grey #505050
    light grey #EFEFEF


    text
    ---------
    mid #636363
    dark #424242
    light #ffffff



    - video capture/camera page
    - next/FT article -> video capture
    - Twitter link -> video capture
  -->

  <style>
    body {
      font-family: Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    ol {
      overflow: hidden;
      margin: 0;
      list-style: none;
      padding: 0;
    }

    .voxpop-logo {
      width: 75px;
    }

    .logged-in {
      float: right;
    }

    .video {
      width: 31%;
      float: left;
      margin: 1%;
      border: 1px solid #EFEFEF;
      box-sizing: border-box;
      position: relative;
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
    }

    .video[data-source="instagram"]:before {
      background: url('data:image/png;base64,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');
      position: absolute;
      top: 0; right: 0;
      height: 20px;
      width: 20px;
      background-size: cover;
      content: '';
    }

    .video[data-bucket]:after {
      content: 'âœ“';
      font-size: 32px;
      position: absolute;
      top: 10px;
      right: 20px;
      color: #3CCF00;
    }

    .username {
      position: absolute;
      background: rgba(0,0,0,0.8);
      top: 0; left: 0;
      color: #fff;
      font-size: 14px;
      padding: 2px;
    }
    .timestamp {
      font-size: 10px;
      text-transform: uppercase;
      font-weight: normal;
    }

    .video video {
      width: 100%;
      margin-bottom: 10px;
    }

    .button-group button {
      background:#EFEFEF;
      border: #505050;
      padding: 4px;
    }
    .button-group button[aria-pressed] {
      background: #006837;
      color: #fff;
    }
    .panel {
      display: none;
    }
    .panel.active {display: block}

    .tabs {
      border-bottom: 4px solid #3CCF00;
    }
    button {
      background-color: #EFEFEF;
      border: none;
      padding: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #636363;
      color: #3CCF00;
    }
    .tabs button {
      font-weight: bold;
      font-size: 16px;
      margin-right: 4px;
    }
    .tabs button[aria-pressed] {
      background-color: #3CCF00;
      color: #fff;
    }
    .create {
      margin-left: 3px;
    }

    .header {
      width: 100%;
      background: #EFEFEF;
    }

    .sidebar {
      width: 15%;
      float: left;
      background: #EFEFEF;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
    }

    .main {
      width: 85%;
      float: left;
      padding: 10px;
      box-sizing: border-box;
    }

    .logged-in {
      padding: 10px;
      font-weight: bold;
    }

    form input {
      width: 100%;
      font-size: 20px;
      margin: 10px 0;
    }

    .tags .label {
      font-weight: bold;
    }

    .publish {
      float: right;
      font-size: 20px;
      padding: 10px;
      background: #3CCF00;
      color: #fff;
    }
    .publish[aria-pressed] {
      background: #505050;
    }

    .video-container {
      clear: both;

    }

    .message {
      margin: 10px 0;
      font-size: 14px;
    }

  </style>
</head>
<body>

  <div class="header">
  <img class="voxpop-logo" src="voxpopper_logo.svg"/>
  <span class="logged-in"><img src="https://next-geebee.ft.com/image/v1/images/raw/http%3A%2F%2Fnext.ft.com%2Fassets%2Ficons%2Fbrand-ft.svg?width=35&format=png&tint=%23000000,%23000000&source=next"/> - Emily Cadman</span>

  </div>
  <div class="sidebar">
    <h3>Trending</h3>
    <ol>
      <li><a href="#">#FifaCrisis</a></li>
      <li><a href="#">Chuck Blazer</a></li>
      <li><a href="#">Al Kazeem</a></li>
      <li><a href="#">Unchartered</a></li>
      <li><a href="#">#RCS2015</a></li>
    </ol>
  </div>
  <div class="main">
    <div class="tabs">
      <button class="create" data-panel="create">+</button>
    </div>

    <section class="panel" data-panel-id="create">
      <h2>Create a new callout</h2>

      <form id="create-form">
      <div>
        <label>Question</label>
        <input name="title" id="title" type="textarea"/>
      </div>

       <div>
        <label>Tags</label>
        <input name="tags" id="tags" type="text"/>
      </div>
        <input name="submit" type="submit" value="Create"/>
      </form>

    </section>
  </div>

  <script>

    function closest(el, selector) {
      var matchesFn;

        // find vendor prefix
        ['matches','webkitMatchesSelector','mozMatchesSelector','msMatchesSelector','oMatchesSelector'].some(function(fn) {
          if (typeof document.body[fn] == 'function') {
            matchesFn = fn;
            return true;
          }
          return false;
        })

        // traverse parents
        while (el!==null) {
          parent = el.parentElement;
          if (parent!==null && parent[matchesFn](selector)) {
            return parent;
          }
          el = parent;
        }

        return null;
      }

      var defaultData = [
      {
        id: 1,
        title: "Should European football boycott the next World Cup?",
        published: false,
        tags: ['#FifaVox', '#FifaCrisis', '#BlatterOut'],
        videos: []
      },
      {
        id: 2,
        title: "#something",
        published: false,
        tags: [],
        videos: []
      }
      ];


      var data = localStorage.getItem('voxpop.data');
      var published = localStorage.getItem('voxpop.published');
      if(data) {
        data = JSON.parse(data);
      } else {
        data = defaultData;
        localStorage.setItem('voxpop.data', JSON.stringify(data));
      }

      if(published) {
        published = JSON.parse(published);
      } else {
        published = {};
        localStorage.setItem('voxpop.published', JSON.stringify(published));
      }

      function newTab(data) {
        var tab = document.createElement('button');
        tab.setAttribute('data-panel', data.id);
        tab.textContent = data.title;
        return tab;
      }

      var sectionTemplate = function(data) {
        return `<div class="title">
          <h2>${data.title}</h2>
          <div class="tags"><span class="label">Tags: </span>` + data.tags.join(', ') + `</div>
          <button class="publish">Publish</button>
          <div class="message"></div>
          <a href="article.html#voxpopper" class="show-article">Show in article</a>
          </div>
        <div class="video-container">

        </div>`
    }

    var videoTemplate = function(video) {

      return `
      <div class="video"` + ((video.selected) ? ` data-bucket ` : ``) + ` data-source=${video.source}>
        <div class="video-cover">
        <video src="${video.src}" controls poster="${video.poster}"></video>
        </div>
        <span class="username">${video.username}</span>
        Published: <time class="timestamp">${video.timestamp}</time>
        <div class="button-group">
          Selected: <input class="selected" type="checkbox" ` + (video.selected ? `checked` : ``) + `/>
          <br/>Group:
          <button name="button" value="0"` + (video.group === 0 ? ` aria-pressed` : ``) + `>Yes</button>
          <button name="button" value="1"` + (video.group === 1 ? ` aria-pressed` : ``) + `>No</button>
        </div>
      </div>`
    }

    function newPanel(data) {
      var panel = document.createElement('section');
      panel.classList.add('panel');
      panel.setAttribute('data-panel-id', data.id);
      panel.innerHTML = sectionTemplate(data);
      return panel;
    }

    function createNewQuestion(panelData) {

      var createTab = document.querySelector('[data-panel="create"]');
      var createPanel = document.querySelector('[data-panel-id="create"]');

      if(document.querySelector('[data-panel-id="' + panelData.id + '"]')) {
        return;
      }
      createTab.parentElement.insertBefore(newTab(panelData), createTab);
      createPanel.parentElement.insertBefore(newPanel(panelData), createPanel);
      var videoContainer = document.querySelector('[data-panel-id="' + panelData.id + '"] .video-container');
      panelData.videos.forEach(function(videoData) {
        videoContainer.insertAdjacentHTML('beforeend', videoTemplate(videoData));

      });
    }
    function createAll() {
      data.forEach(createNewQuestion);
      document.querySelector('[data-panel]').setAttribute('aria-pressed', '');
      document.querySelector('[data-panel-id]').classList.add('active');
    }

    function saveData() {
      localStorage.setItem('voxpop.data', JSON.stringify(data));
    };
    function savePublished() {
      localStorage.setItem('voxpop.published', JSON.stringify(published));
    };
    createAll();

    document.addEventListener('click', function (e) {
      if(!(e.target.tagName == 'BUTTON' && e.target.parentElement.className === 'button-group')) {
        return;
      }
      var alreadyPressed = e.target.parentElement.querySelector('.button-group button[aria-pressed]');

      if(e.target.hasAttribute('aria-pressed')) {
        e.target.removeAttribute('aria-pressed');
      } else {
        if(alreadyPressed) { alreadyPressed.removeAttribute('aria-pressed') };
        e.target.setAttribute('aria-pressed', '');
      }


      var allVideos =Array.prototype.slice.call( document.querySelector('.video-container').children );

      var allTabs =Array.prototype.slice.call( document.querySelector('.tabs').children );

      var index = allVideos.indexOf(closest(e.target, '.video'));
      var currentTabIndex = allTabs.indexOf(allTabs.filter(function(tab) {
        return tab.hasAttribute('aria-pressed');
      })[0]);

      data[currentTabIndex].videos[index].group = e.target.parentElement.querySelector('button[aria-pressed]') ? parseInt(e.target.parentElement.querySelector('button[aria-pressed]').value) : null;

      saveData();
    });

document.addEventListener('change', function (e) {

  if(e.target.getAttribute('type') !== 'checkbox') {
    return;
  };
  var allVideos =Array.prototype.slice.call( document.querySelector('.video-container').children );

  var allTabs =Array.prototype.slice.call( document.querySelector('.tabs').children );

  var index = allVideos.indexOf(closest(e.target, '.video'));
  var currentTabIndex = allTabs.indexOf(allTabs.filter(function(tab) {
    return tab.hasAttribute('aria-pressed');
  })[0]);

  data[currentTabIndex].videos[index].selected = e.target.checked;
  if(e.target.checked) {
    e.target.parentElement.parentElement.setAttribute('data-bucket' ,'');
  } else {
    e.target.parentElement.parentElement.removeAttribute('data-bucket');
  }
  saveData();
});

document.querySelector('.tabs').addEventListener('click', function (e) {
  if(e.target.tagName !== 'BUTTON') {
    return;
  }
  var alreadyPressed = e.target.parentElement.querySelector('[aria-pressed]');
  var activePanel = document.querySelector('.panel.active');

  if(e.target !== alreadyPressed) {
    alreadyPressed.removeAttribute('aria-pressed');
    activePanel.classList.remove('active');
    e.target.setAttribute('aria-pressed', '');
    document.querySelector('[data-panel-id="' + e.target.getAttribute('data-panel') + '"]').classList.add('active');
  }
});

document.querySelector('#create-form').addEventListener('submit', function(e) {
  e.preventDefault();

  var createTab = document.querySelector('[data-panel="create"]');
  var createPanel = document.querySelector('[data-panel-id="create"]');
  var lastTab = createTab.previousElementSibling;
  var newTabId =  parseInt(lastTab.getAttribute('data-panel')) + 1;
  var newPanel = {
    id: newTabId,
    title: document.forms[0].title.value,
    tags: document.forms[0].tags.value.split(','),
    published: false,
    videos: []
  };

  data.push(newPanel);
  saveData();
  createNewQuestion(newPanel);

  var newPanel = document.querySelector('[data-panel-id="' + newTabId + '"]');
  var newTab = document.querySelector('[data-panel="' + newTabId + '"]');

  newPanel.classList.add('active');
  createPanel.classList.remove('active');
  newTab.setAttribute('aria-pressed', '');
  createTab.removeAttribute('aria-pressed');

  populateWithVideos();

});

document.addEventListener('click', function(e) {
  if(e.target.className !== 'publish') {
    return;
  }
  e.preventDefault();

  var allTabs =Array.prototype.slice.call( document.querySelector('.tabs').children );

  var currentTabIndex = allTabs.indexOf(allTabs.filter(function(tab) {
    return tab.hasAttribute('aria-pressed');
  })[0]);


    data[currentTabIndex].published = true;

    var grouped = {};
    data[currentTabIndex].videos.forEach(function(video) {
      if(!video.selected) {
        return;
      }
      grouped[video.group] = grouped[video.group] || [];
      grouped[video.group].push(video);
    });

    published[data[currentTabIndex].id] = {
      id: data[currentTabIndex].id,
      title: data[currentTabIndex].title,
      tags: data[currentTabIndex].tags,
      groupedVideos: grouped
    };

  document.querySelector('.message').textContent = new Date() + ' - published changes!';
  saveData();
  savePublished();



});

function addInstagramVideosCallback(response)
{
  var allTabs =Array.prototype.slice.call( document.querySelector('.tabs').children );

  var currentTabIndex = allTabs.indexOf(allTabs.filter(function(tab) {
    return tab.hasAttribute('aria-pressed');
  })[0]);
  var newVideo;
  var activeVideoList = document.querySelector('.panel.active .video-container');

  response.data.forEach(function (media) {
    if(media.videos) {
      newVideo = {
          src: media.videos['standard_resolution'].url,
          poster: media.images['standard_resolution'].url,
          username: media.user.username,
          timestamp: new Date(parseInt(media['created_time'] + '000')),
          source: 'instagram',
          selected: false,
          group: 1
      }
      if(!data[currentTabIndex].videos.some(function(video) {
        return video.src === newVideo.src;
      })) {
        data[currentTabIndex].videos.push(newVideo);
        activeVideoList.insertAdjacentHTML('beforeend', videoTemplate(newVideo));
      }

    }
  });


}

function addInstagramVideos(tag) {
  var script = document.createElement('script');
  script.src = 'https://api.instagram.com/v1/tags/' + tag.replace('#', '') + '/media/recent?client_id=7d052d10ce3a4d0fb92aa5fa604743f2&count=1000&callback=addInstagramVideosCallback'
  document.getElementsByTagName('head')[0].appendChild(script);
}

function populateWithVideos() {
 var allTabs =Array.prototype.slice.call( document.querySelector('.tabs').children );

  var currentTabIndex = allTabs.indexOf(allTabs.filter(function(tab) {
    return tab.hasAttribute('aria-pressed');
  })[0]);

  data[currentTabIndex].tags.forEach(addInstagramVideos);
}

populateWithVideos();

</script>
</body>
</html>
